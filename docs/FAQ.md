# UAV学习FAQ

> **问题追踪说明**：本文档采用层级编号系统记录问题演进过程
> - `[Q-X]` 主问题（X为序号）
> - `[Q-X.Y]` 子问题（Y为子序号）
> - `[Q-X.Y.Z]` 延伸问题（Z为延伸序号）
> - 每个问题后标注首次提问日期，方便追溯学习路径

---

# 2026年1月25日

## [Q-1] AHRS相关基础概念

### 1.1 什么是AHRS？AHRS与IMU是什么关系？

**AHRS**（Attitude and Heading Reference System，航向姿态参考系统）是飞控中负责计算和输出飞机姿态（俯仰、横滚、航向）的系统模块。

**AHRS与IMU的关系**：
```
IMU（惯性测量单元）          AHRS（航向姿态参考系统）
┌─────────────┐              ┌─────────────┐
│ 加速度计     │              │ 姿态解算     │
│ 陀螺仪      │ ───数据───> │ 算法融合     │ ───> 姿态输出
│ 磁力计(可选) │              │ 航向计算     │      (pitch/roll/yaw)
└─────────────┘              └─────────────┘
```

- **IMU**是硬件传感器，负责采集原始数据（加速度、角速度）
- **AHRS**是软件算法，负责用IMU数据计算出飞机的姿态角度
- 飞控固件中的AHRS算法会融合加速度计、陀螺仪、磁力计（如果有）的数据，输出精确的航向和姿态

### 1.2 AHRS2和AHRS3有什么不同？

- **AHRS2**：第二套航向姿态参考系统，使用EKF2（扩展卡尔曼滤波）算法
- **AHRS3**：第三套航向姿态参考系统，使用EKF3算法，通常是更新版
- 两者计算原理相同，但EKF3可能有更好的抗干扰能力或新特性
- 日常使用任一一个即可，EKF3是较新的默认值

### 1.3 陀螺仪是什么？IMU接收什么数据？

**陀螺仪**（Gyroscope）是测量物体角速度的传感器，即"旋转速度"：

| 传感器 | 测量内容 | 单位 |
|-------|---------|------|
| 加速度计 | 线性加速度（包含重力） | m/s² 或 mg |
| 陀螺仪 | 角速度（旋转速度） | °/s 或 rad/s |
| 磁力计 | 磁场强度（用于校准航向） | Gauss或μT |

**IMU接收的数据**：
- 3轴加速度（X、Y、Z）
- 3轴角速度（X、Y、Z）
- （如果有磁力计）3轴磁场强度

飞控用这些数据实时计算：飞机现在"歪不歪"（pitch/roll）、"转了多少"（yaw）。

### 1.4 什么是"Bad AHRS"问题？

"Bad AHRS"是指AHRS系统计算出的姿态数据不可信，常见原因：

| 原因 | 说明 | 解决方法 |
|-----|------|---------|
| IMU未校准 | 加速度计/陀螺仪零点偏移 | 重新校准加速度计 |
| 飞控不平放 | 初始姿态超出正常范围 | 确保水平放置后再通电 |
| 磁场干扰 | 磁力计数据异常 | 远离金属物体，重新校准罗盘 |
| 传感器故障 | IMU硬件问题 | 检查连接或更换飞控 |
| 初始化未完成 | 上电后需要30-60秒稳定 | 等待完全启动 |

飞控解锁前会检查AHRS状态，如果数据异常会阻止解锁并提示"Bad AHRS"。

### 1.5 IMU组件详解与数据流向

#### 1.5.1 IMU内部有哪些组件？

**IMU（Inertial Measurement Unit，惯性测量单元）** 是由多个传感器组成的模块，内部主要组件：

```
┌─────────────────────────────────────────────────────────────────┐
│                         IMU 模块内部结构                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   ┌─────────────┐                                               │
│   │  加速度计    │  ← 测量线性加速度（X、Y、Z轴）                  │
│   │ Accelerometer│  ← 包含微机械结构，可感知重力变化               │
│   └──────┬──────┘                                               │
│          │                                                       │
│   ┌──────▼──────┐                                               │
│   │  陀螺仪      │  ← 测量角速度/旋转速度（X、Y、Z轴）             │
│   │  Gyroscope  │  ← 基于科里奥利效应或振动原理                   │
│   └──────┬──────┘                                               │
│          │                                                       │
│   ┌──────▼──────┐     ┌─────────────────┐                       │
│   │  磁力计      │     │  温度传感器      │  ← 补偿温度漂移         │
│   │  Magnetometer│ ←→ │  Temperature    │  (部分IMU包含)          │
│   └─────────────┘     │   Sensor        │                       │
│                       └─────────────────┘                       │
│                                                                 │
│   ┌─────────────────────────────────────────────────────────┐  │
│   │                    信号处理电路                           │  │
│   │  ADC（模数转换）→ 滤波 → 校准补偿 → 输出到飞控              │  │
│   └─────────────────────────────────────────────────────────┘  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

**各组件详细介绍**：

| 组件 | 英文名 | 测量内容 | 工作原理 | 输出数据 |
|-----|-------|---------|---------|---------|
| **加速度计** | Accelerometer | 线性加速度（含重力） | MEMS微机械结构，质量块在加速度作用下移动 | X/Y/Z轴加速度（m/s²或g） |
| **陀螺仪** | Gyroscope | 角速度（旋转速度） | 科里奥利效应或振动环结构 | X/Y/Z轴角速度（°/s或rad/s） |
| **磁力计** | Magnetometer | 磁场强度 | 霍尔效应或磁阻效应 | X/Y/Z轴磁场（Gauss或μT） |
| **温度传感器** | Temperature | 芯片温度 | 热敏电阻 | 温度值（°C） |

#### 1.5.2 IMU可以捕捉哪些信息？

**IMU能捕捉的信息**：

```
┌─────────────────────────────────────────────────────────────────┐
│                      IMU 数据捕捉能力                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │                        运动状态                            │   │
│  ├──────────────────────────────────────────────────────────┤   │
│  │                                                          │   │
│  │  1. 线性运动（加速度计）                                   │   │
│  │     • 前进/后退加速度                                      │   │
│  │     • 左右横向加速度                                       │   │
│  │     • 垂直升降加速度（含重力g=9.8m/s²）                    │   │
│  │                                                          │   │
│  │  2. 旋转运动（陀螺仪）                                     │   │
│  │     • 俯仰角速度（Pitch rate）                            │   │
│  │     • 横滚角速度（Roll rate）                             │   │
│  │     • 偏航角速度（Yaw rate）                              │   │
│  │                                                          │   │
│  │  3. 方向感知（磁力计）                                     │   │
│  │     • 地球磁场方向                                         │   │
│  │     • 机头朝向（相对于磁北）                               │   │
│  │                                                          │   │
│  └──────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │                        状态推断                            │   │
│  ├──────────────────────────────────────────────────────────┤   │
│  │                                                          │   │
│  │  通过积分计算可获得：                                      │   │
│  │  • 速度 = 加速度对时间积分                                 │   │
│  │  • 位置 = 速度对时间积分                                   │   │
│  │  • 角度 = 角速度对时间积分                                 │   │
│  │                                                          │   │
│  │  ⚠ 注意：积分会产生漂移误差，长时间使用需GPS/EKF校正       │   │
│  │                                                          │   │
│  └──────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

**原始数据示例**（通过MAVLink RAW_IMU消息获取）：

| 字段 | 含义 | 单位 | 示例值 |
|-----|------|-----|-------|
| xacc | X轴加速度 | mg | 10 |
| yacc | Y轴加速度 | mg | -5 |
| zacc | Z轴加速度 | mg | 980（≈1g重力） |
| xgyro | X轴角速度 | rad/s | 0.01 |
| ygyro | Y轴角速度 | rad/s | -0.02 |
| zgyro | Z轴角速度 | rad/s | 0.05 |
| xmag | X轴磁场 | mgauss | 200 |
| ymag | Y轴磁场 | mgauss | 50 |
| zmag | Z轴磁场 | mgauss | 400 |

#### 1.5.3 AHRS使用IMU的哪些数据？

**AHRS从IMU使用的数据总结**：

| 数据源 | 使用目的 | 贡献 |
|-------|---------|------|
| **加速度计** | 提取重力方向，确定Pitch和Roll | 关键 |
| **陀螺仪** | 测量旋转速度，通过积分计算角度变化 | 关键 |
| **磁力计** | 提供绝对航向参考，校正Yaw漂移 | 重要（但非所有AHRS必须） |

#### 1.5.4 AHRS除了IMU数据还会使用哪些组件的数据？

**AHRS的完整数据来源**：

| 数据源 | 数据内容 | 在AHRS中的作用 | 重要性 |
|-------|---------|---------------|-------|
| **IMU加速度计** | X/Y/Z加速度 | 重力方向提取、Pitch/Roll计算 | ⭐⭐⭐ 必需 |
| **IMU陀螺仪** | X/Y/Z角速度 | 角度积分、动态旋转跟踪 | ⭐⭐⭐ 必需 |
| **IMU磁力计** | X/Y/Z磁场 | 航向参考、Yaw漂移校正 | ⭐⭐ 推荐 |
| **GPS** | 经纬度、速度 | 航向辅助、静止检测、漂移校正 | ⭐⭐ 室外推荐 |
| **气压计** | 气压高度 | 垂直参考（部分EKF使用） | ⭐ 辅助 |
| **光流** | 视觉位移 | 室内位置估计 | ⭐ 室内场景 |
| **视觉里程计** | 视觉位姿 | 高级位置/姿态估计 | ⭐ 高级场景 |

### 1.6 EKF与AHRS的关系

- **AHRS**是一个**系统概念**，负责输出航向和姿态
- **EKF**（扩展卡尔曼滤波）是一种**算法**，用于实现AHRS
- ArduPilot中：
  - EKF2 = 使用EKF算法实现的第二套AHRS
  - EKF3 = 使用EKF算法实现的第三套AHRS
  - 两者都是AHRS的具体实现方式

**关系图**：
```
                    AHRS（航向姿态参考系统）
                           │
                           ├── 传统互补滤波算法
                           │
                           └── EKF算法（扩展卡尔曼滤波）← 现代主流
                                      │
                                      ├── EKF2
                                      └── EKF3
```

EKF相比传统互补滤波的优势：
- 能更好地融合多个传感器数据
- 对噪声和异常值有更好的处理
- 能输出状态估计的置信度

---

## [Q-2] 无人机系统状态与飞行模式

### 2.1 system_status.state有哪些状态？

无人机系统状态（按解锁流程的顺序）：

| 状态 | 含义 | 解锁可能性 |
|-----|------|----------|
| **UNINIT** | 未初始化 | 否 |
| **BOOT** | 启动中 | 否 |
| **CALIBRATING** | 传感器校准中 | 否 |
| **STANDBY** | 待机（就绪） | ✓ 可解锁 |
| **ACTIVE** | 活动中（已起飞） | N/A |
| **CRITICAL** | 严重警告 | 视情况 |
| **EMERGENCY** | 紧急情况 | 否 |
| **POWEROFF** | 关机 | 否 |

**注意**：实际状态名称可能因固件版本略有差异，但核心逻辑一致。

### 2.2 mode.name有哪些模式？Stabilize为什么不能直接解锁？

**常见飞行模式**：

| 模式 | 名称 | 特点 | 解锁要求 |
|-----|------|------|---------|
| **STABILIZE** | 自稳模式 | 手动控制，飞机自动回正 | 必须通过PreArm |
| **ALT_HOLD** | 定高模式 | 自动保持当前高度 | 必须通过PreArm |
| **GUIDED** | 引导模式 | 接受代码指令飞行 | 必须通过PreArm |
| **LOITER** | 悬停模式 | GPS定点悬停 | 必须通过PreArm |
| **RTL** | 返航模式 | 自动返航 | 必须通过PreArm |
| **AUTO** | 自动模式 | 按任务脚本飞行 | 必须通过PreArm |
| **LAND** | 降落模式 | 自动降落 | 已解锁时可用 |

**为什么Stabilize模式不能直接解锁？**

实际上，**Stabilize模式下也可以解锁**，前提是通过PreArm检查。真正的问题可能是：

1. **PreArm检查未通过** → 显示为"PreArm: Check"或"Bad AHRS"
2. **传感器未就绪** → `is_armable=False`
3. **某些固件版本对Stabilize模式有额外限制**

建议先切换到GUIDED或ALT_HOLD模式尝试解锁，这是更常见的解锁模式。

---

## [Q-3] 解锁流程与安全检查

### 3.1 起飞前检查的完整顺序

```
┌─────────────────────────────────────────────────────────────┐
│  起飞前检查顺序（时间轴）                                      │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  1. 飞控上电                                                  │
│     ↓                                                       │
│  2. 硬件自检（CPU、内存、传感器连接）                            │
│     ↓                                                       │
│  3. 传感器初始化（IMU、磁力计、GPS）                            │
│     ↓                                                       │
│  4. 传感器校准（可能自动或手动）                                 │
│     ↓                                                       │
│  5. EKF/AHRS 初始化并收敛                                      │
│     ↓                                                       │
│  6. PreArm 安全检查  ← 【关键步骤】                            │
│     ↓ （通过则 is_armable=True）                              │
│  7. 切换飞行模式（GUIDE/ALT_HOLD）                             │
│     ↓                                                       │
│  8. 执行解锁指令                                              │
│     ↓                                                       │
│  9. 电机启动                                                  │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 3.2 PreArm检查是什么？出现在哪一步？

**PreArm检查**是飞控在解锁前进行的一套完整安全检查，目的是确保所有传感器和系统都正常工作。

**PreArm检查的内容**：

| 检查项 | 检查内容 | 失败表现 |
|-------|---------|---------|
| IMU健康 | 加速度计/陀螺仪数据正常 | "Bad IMU" |
| AHRS健康 | 姿态数据合理 | "Bad AHRS" |
| 磁力计 | 罗盘数据正常、无干扰 | "Bad Compass" |
| GPS | GPS已定位、信号足够 | "Bad GPS" |
| 电池 | 电压足够 | "Low Battery" |
| 飞控水平 | 放置在水平面 | "Level horizon" |
| 遥控器 | 遥控信号正常（若已连接） | "Check RC" |
| 模式有效 | 当前模式允许解锁 | - |

**PreArm检查的时机**：
- 在飞控完全启动后、用户尝试解锁前执行
- 只有通过PreArm检查后，`is_armable`才会变为`True`
- 失败时会显示具体错误信息（如"PreArm: Compass not calibrated"）

### 3.3 is_armable状态由什么决定？

`vehicle.is_armable`是以下条件的**与**运算（全部满足才为True）：

```
is_armable = (传感器全部就绪) AND (PreArm全部通过) AND (无严重错误)
```

具体因素：

| 因素 | 说明 |
|-----|------|
| IMU数据有效 | 加速度和角速度数据在合理范围 |
| AHRS已收敛 | 姿态解算完成，角度稳定 |
| 电池电压正常 | 高于最低保护阈值（通常10V左右） |
| GPS定位（若需要） | 某些模式需要GPS定位后才能解锁 |
| 无严重错误 | 无传感器故障、IMU冲突等 |
| 飞控固件就绪 | 完成启动初始化 |

### 3.4 如何让飞控解锁？硬性要求是什么？

**标准解锁流程**：

```python
# 1. 等待is_armable
while not vehicle.is_armable:
    print("等待飞控就绪...")
    time.sleep(1)

# 2. 切换到允许解锁的模式
vehicle.mode = VehicleMode("GUIDED")

# 3. 解锁
vehicle.armed = True

# 4. 确认解锁
while not vehicle.armed:
    print("等待解锁...")
    time.sleep(0.5)
```

**硬性要求**：

| 要求 | 说明 |
|-----|------|
| PreArm全部通过 | 传感器正常、无错误 |
| 电池电压足够 | 通常>10.5V（取决于固件设置） |
| 飞控水平放置 | 启动时保持水平 |
| 模式允许解锁 | GUIDED/ALT_HOLD/STABILIZE等 |
| 无紧急停止 | 安全开关未激活 |

**能否强制解锁？**

理论上可以通过MAVLink命令强制解锁（设置ARMING_CHECK为0跳过检查），但**强烈不建议**：
- 跳过安全检查可能导致起飞事故
- 只有在确认传感器故障但需要紧急降落时才考虑
- 正常学习/测试时务必通过PreArm检查

---

## [Q-4] 传感器与模块

### 4.1 超声波避障模块数据飞控能获取吗？

**可以获取**，但取决于具体配置：

| 配置方式 | 数据获取方式 |
|---------|-------------|
| **飞控原生支持**（如某些型号的超声波传感器） | 通过MAVLink消息（如DISTANCE_SENSOR）自动接收 |
| **自定义连接**（如连接到香橙派） | 香橙派读取后通过MAVLink或TCP发送给飞控 |
| **连接到飞控的UART** | 固件支持的情况下，可配置为测距仪数据源 |

**如果超声波模块连接在飞控上**：
- 飞控会收到DISTANCE_SENSOR消息
- 可在Mission Planner的传感器状态中查看
- 固件可能自动使用此数据进行避障（若已配置）

**如果连接在香橙派上**：
- 香橙派用Python读取超声波数据
- 通过RC Override或MAVLink发送给飞控
- 或通过TCP传输到地面站，由地面站决定如何响应

### 4.2 磁力计的作用是什么？

**磁力计**（Compass/Magnetometer）的作用是**测量地球磁场方向**，用于：

| 功能 | 说明 |
|-----|------|
| **航向计算** | 确定飞机机头朝向（0-360°） |
| **EKF融合** | 与陀螺仪数据融合，提高航向精度 |
| **GPS辅助** | 辅助GPS在动态情况下保持航向稳定 |
| **返航指引** | RTL模式时知道"家"在哪个方向 |

**为什么需要磁力计？**

陀螺仪只能测量"转了多少"，不能知道"当前朝向"。磁力计提供绝对航向参考：

```
┌─────────────────────────────────────────────┐
│                                             │
│    陀螺仪：知道我正在以10°/s向右转           │
│            但不知道现在朝向哪个方向            │
│                                             │
│    磁力计：知道我机头现在指向北偏东30°        │
│            但不知道我正在转弯                 │
│                                             │
│    两者融合 = 既知道当前朝向，又知道转了多少   │
│                                             │
└─────────────────────────────────────────────┘
```

**磁力计容易受干扰**：
- 靠近电机、电调、大电流导线
- 靠近金属物体（螺丝、铁架）
- 靠近磁场源（扬声器、磁铁）

受到干扰时，会出现"Bad Compass"或航向漂移，需要重新校准或远离干扰源。

---

## 延伸问题待解答（待追问）

- `[Q-2.3]` 为什么不同模式解锁条件不同？
- `[Q-3.5]` 如何手动触发或跳过PreArm检查？
- `[Q-4.3]` 如何在代码中读取超声波数据？

---

*本文档更新时间：2026年1月26日*
*版本：v1.2（完整版：含Q-1至Q-4全部内容）*
